#!/bin/bash
set -e

echo "============================================================"
echo "üöÄ –ó–ê–ü–£–°–ö –°–í–ê–î–ï–ë–ù–û–ì–û –ë–û–¢–ê"
echo "============================================================"
echo "üÜî Process ID: $$"
echo "üïê –í—Ä–µ–º—è: $(date -Iseconds)"
echo "============================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –¥–≤–∞–∂–¥—ã
LOCK_FILE="/tmp/wedding_bot.lock"
if [ -f "$LOCK_FILE" ]; then
    OLD_PID=$(cat "$LOCK_FILE")
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo "üö® –û–®–ò–ë–ö–ê: –ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $OLD_PID)!"
        echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω"
        exit 1
    else
        echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ä—ã–π lock —Ñ–∞–π–ª, —É–¥–∞–ª—è–µ–º..."
        rm -f "$LOCK_FILE"
    fi
fi

# –°–æ–∑–¥–∞–µ–º lock —Ñ–∞–π–ª
echo $$ > "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

echo "‚úÖ Lock —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω (PID: $$)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ -z "$BOT_TOKEN" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    exit 1
fi

if [ -z "$GOOGLE_SHEETS_ID" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: GOOGLE_SHEETS_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ä—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10000 –¥–ª—è Render)
export PORT=${PORT:-10000}

echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
echo "üåê –ü–æ—Ä—Ç: $PORT"
echo "============================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ Go –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω
# pgrep –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Docker –æ–±—Ä–∞–∑–∞—Ö, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
if command -v pgrep > /dev/null 2>&1; then
    if pgrep -f "./server" > /dev/null; then
        echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å server"
        echo "   PID: $(pgrep -f './server')"
        echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å"
    fi
else
    echo "‚ÑπÔ∏è pgrep –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
if [ ! -f "./server" ]; then
    echo "üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    go build -o server ./cmd/server
    if [ $? -ne 0 ]; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!"
        exit 1
    fi
    echo "‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
fi

# –ó–∞–ø—É—Å–∫ Go –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "ü§ñ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (Go)..."
echo "============================================================"
exec ./server

